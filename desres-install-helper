#!/bin/sh
set -e
#set -x
. $DESRES_ROOT/modules/init/sourceme.sh
module add gardenutils/1.9.2/lib-sh
module add treetop/87-Desmond/bin   
. desres-install-functions
trap 'desres_trapped_exit' EXIT

desres_require_cleanenv

NAME=msys
VERSION=`src/version.py`
DESCRIPTION="Biomolecular Structure Library"

# shared library dependencies
GCC=gcc/4.7.2-23A
BOOST=boost/1_51_0-28A
PYTHON=Python/2.7.3-07A
SQLITE=$(treetop sqlite)
PCRE=$(treetop pcre)
ANTLR=$(treetop antlr)
JSON=fastjson/1.4.7
MOLFILE=molfile/1.10.4
PERIODICFIX=periodicfix/2.4.3
NUMPY=numpy/1.6.2-31A
LPSOLVE=$(treetop lp_solve)
PRIMEGEN=primegen/0.97-05

# build and documentation
SCONS=$(treetop scons)
SCONSUTILS=$(treetop sconsutils)
SPHINX=$(treetop Sphinx)

loadmodules() {
    module load \
        $GCC/bin \
        $PYTHON/bin \
        $PYTHON/lib \
        $NUMPY/include \
        $NUMPY/lib-python \
        $SCONS/bin \
        $SCONSUTILS/lib-python \
        $BOOST/Release/lib \
        $SQLITE/lib \
        $PCRE/lib-shared \
        $ANTLR/lib \
        $JSON/lib \
        $PERIODICFIX/lib \
        $MOLFILE/lib \
        $LPSOLVE/lib \
        $PRIMEGEN/lib \
        $SPHINX/bin 
    
   export MSYS_VERSION=$VERSION

   desres_module_stripcolons
}

genmodules() {
    # get modulefile boilerplate
    hdr=`desres_module_header $NAME $VERSION`

    # Python modules
    cat << EOF > $MODULEDIR/lib-python
$hdr
module-whatis {$NAME - $DESCRIPTION}

prereq $PYTHON/bin
prereq $NUMPY/lib-python
prepend-path PYTHONPATH $PREFIX/lib/python
setenv MSYS_PREFIX "$PREFIX"
EOF

    # library
    cat << EOF > $MODULEDIR/lib
$hdr
module-whatis {$NAME - $DESCRIPTION}

prepend-path DESRES_MODULE_CPPFLAGS -I$PREFIX/include
prepend-path DESRES_MODULE_LDFLAGS "-L$PREFIX/lib -Wl,-rpath,$PREFIX/lib"
prepend-path DESRES_MODULE_LDLIBS   -lmsys
setenv MSYS_PREFIX "$PREFIX"
EOF

    # executables
    cat << EOF > $MODULEDIR/bin
$hdr
module-whatis {$NAME - $DESCRIPTION}
prepend-path PATH $PREFIX/bin
prepend-path MANPATH $PREFIX/doc/man
setenv MSYS_PREFIX "$PREFIX"
EOF
}

genhelp() {
    cat release_notes.txt >> $PREFIX/ModulesHelp
    cat <<EOF >> $PREFIX/ModulesHelp

See documentation in 
http://gardendoc.nyc.desres.deshaw.com/$NAME/$VERSION/doc/html/index.html

EOF
}

gendocs() {
    (cd doc && VERSION=$VERSION make man html)
    mkdir -p $PREFIX/doc/man/man1
    cp -r doc/build/html $PREFIX/doc/
    cp doc/build/man/*.1 $PREFIX/doc/man/man1
}

case $1 in
    --name)
        echo $NAME
        ;;
    --version)
	echo $VERSION
        ;;
    --exec)
        shift
	loadmodules
        "$@"
        ;;
    --install)
	loadmodules
	desres_require_prefix
	desres_require_moduledir

        $0 --exec scons -j4 install PREFIX=${PREFIX} OBJDIR=${TMPDIR}

        ./tests/ut.py

	genhelp
	genmodules
        gendocs

        ;;
    --help)
        desres_install_helper_usage
        ;;
    # It's not an error if nothing matches.  desres-install may invent
    # other arguments in the future.
esac

desres_clean_exit 0
