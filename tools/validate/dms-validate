#!/usr/bin/env desres-exec
# -*- python -*-
#{
# source `dirname $0`/../share/MODULES && \
# exec garden with -c -m $PYTHON/bin \
# -- python $0 "$@"
#}

'''dms-validate system.dms [ options ]

`dms-validate` flags conditions that are likely to be errors in a chemical
system.  The set of "basic" checks are always performed; additional checks
can be enabled using various command line flags. 

The set of basic checks comprise the following:

 * nonbonded: if a nonbonded table exists, every particle must have a 
   nonbonded param assignment.

 * knot: there must not be bonds passing through rings of size 10 or fewer.

 * nonzerobox: the volume of the global cell must be positive.
 
 * masslessatoms: there should be no massless atoms with atomic number > 0.

The set of strict checks comprise the following items.  Note that it
is certainly possible for a valid simulation to be performed using a
system that passes none of its strict checks!  However, it may be worth
investigating why a system fails theses checks.

 * constraints: the system must have constraint terms.  

 * consistent masses: Particles with equal atomic number must have equal mass.
   Pseudo particles (those with atomic number zero) are excluded from the
   check.

 * sparsify: every 1-4 bond (i.e., pair of atoms separated by three 
   distinct bonds) must be included in the exclusion table.

 * split waters: each water molecule must have its own unique resid,
   and live in its own residue.

Desmond-specific checks:

 * bonded terms: check that neither the exclusion table nor any table
   in the bond_term metable contains terms whose atoms are not connected
   through the bond table.  

 * groups: check that all atoms in a bonded term are within a typical
   clone buffer radius of each other.  The value for the clone buffer
   used in dms-validate is 5.5, but an alternative radius may be provided
   using the dms-check-groups tool.

'''

import sys, os
sys.path.insert(0,os.path.join(os.path.dirname(__file__),'..','lib','python'))

import msys
from msys import validate

def main():
    import optparse
    parser = optparse.OptionParser(__doc__)
    parser.add_option('--strict', action='store_true', default=False,
            help="Run strict tests")
    parser.add_option('--desmond', action='store_true', default=False,
            help="Run Desmond-specific tests")
    parser.add_option('--verbose', action='store_true', default=False,
            help="Be chatty")
    parser.add_option('--all', action='store_true', default=False,
            help="Run all tests")
    parser.add_option('--anton', action='store_true', default=False,
            help="Run Anton-specific tests")

    opts, args = parser.parse_args()
    if len(args)!=1:
        parser.error("incorrect number of arguments")

    mol=msys.Load(args[0])
    result=validate.Validate(mol, **opts.__dict__)
    return not result.wasSuccessful()

if __name__=="__main__": exit(main())

# vim: filetype=python
