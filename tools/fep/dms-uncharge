#!/usr/bin/env desres-exec
# -*- python -*-
#{
# desres-cleanenv $MSYS_CLEANENV -- python $0 "$@"
#}

'''
dms-uncharge a.dms out.dms [options]

Create an alchemical dms file such that the selected atoms have their
charges set to 0 in the B state.
'''

import msys

def UnchargeAlchemical( mol, seltext ):
    ''' make the selected atoms alchemical, and set their charge to 0 in the
    B state.
    '''
    try:
        nonbonds=mol.table('nonbonded')
    except ValueError:
        nonbonds=None

    nbmap=dict()
    if nonbonds:
        for term in nonbonds.terms:
            nbmap[term.atoms[0]] = term

    atoms=mol.atomselect(seltext)
    if not atoms:
        print >> sys.stderr, "WARNING: UnchargeAlchemical -- no atoms in selection"
        return
    for atom in atoms:
        atom.alchemical=True
        atom.chargeB = 0.0
        nb = nbmap.get(atom)
        if nb is not None:
            nb.paramB = nb.param
        elif nonbonds is not None:
            raise ValueError, "No nonbond found for atom %s" % atom



def main():
    import optparse
    parser = optparse.OptionParser(__doc__)

    parser.add_option('-s', '--selection', default='all',
        help='Use only atoms in selection')

    opts, args = parser.parse_args()
    if len(args)!=2: parser.error("incorrect number of arguments")

    a_name, o_name = args
    mol=msys.LoadDMS(a_name)
    
    UnchargeAlchemical(mol, opts.selection)

    msys.SaveDMS(mol, o_name)

if __name__=="__main__": exit(main())

# vim: filetype=python
