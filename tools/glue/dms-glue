#!/usr/bin/env desres-exec
# -*- python -*-
#{
# desres-cleanenv $MSYS_CLEANENV -- python $0 "$@"
#}

'''
dms-glue input.dms output.dms [-s | --selection seltext ]
                              [--replace]

Add minimal glue to the atoms in the selection.  The default set of atoms
for glue is 'protein'.
'''

import sys
import msys
from msys import glue

def main():
    import optparse
    parser = optparse.OptionParser(__doc__)

    parser.add_option('-s', '--selection', default='protein')
    parser.add_option('--replace', action='store_true', default=False,
            help='Replace any existing glue')
    parser.add_option('-v', '--verbose', action='store_true', default=True)

    opts, args = parser.parse_args()
    if len(args)!=2:
        parser.error("incorrect number of arguments")

    if opts.verbose: print "Loading input file <%s>" % args[0]
    mol=msys.LoadDMS(args[0])

    if opts.verbose: 
        pairs=mol.gluePairs()
        print "Input file contains %d glue pairs:" % len(pairs)
        if pairs: 
            for g in pairs:
                print "\t%d %d" % g
            print 

    atoms=mol.select(opts.selection)
    if opts.verbose: print "Finding glue from %d atoms" % len(atoms)

    pairs=glue.FindGlue(atoms)
    if opts.verbose:
        print "Adding %d glue pair%s:" % (len(pairs), 's' if len(pairs)>1 else '')
        for p in sorted(pairs):
            print "\t%d %d" % p

    if opts.verbose and opts.replace:
        print "Replacing existing glue"
        for g in mol.gluePairs(): mol.delGluePair(*g)

    for p in pairs:
        mol.addGluePair(*p)

    if opts.verbose: print "Writing DMS file <%s>" % args[1]
    msys.SaveDMS(mol, args[1])
    return 0

if __name__=="__main__": exit(main())

# vim: filetype=python
