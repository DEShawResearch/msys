#!/usr/bin/env desres-exec
#{
# desres-cleanenv -m numpy/1.6.2-31A/lib-python \
# -- python $0 "$@"
#}

'''
dms-scale-vdw input.dms output.dms [ options ]

Scale vdw interactions between selected atoms.

Restrictions: produces a nonbonded_scaled_param table and therefore
              may not be usable on older Anton software versions.
 
              Works for vdw_funct=vdw_12_6 only.
'''

import sys, os
sys.path.insert(0,os.path.join(os.path.dirname(__file__),'..','lib','python'))

import msys
from msys import vdw

def main():
    import optparse
    parser = optparse.OptionParser(__doc__)

    parser.add_option('-s', '--scale-sigma', type='float', 
            help='scale factor for sigma', default=1)
    parser.add_option('-e', '--scale-epsilon', type='float', 
            help='scale factor for epsilon', default=1)
    parser.add_option('-l', '--ligand', action='append', 
            help='atom selection for a ligand')

    opts, args = parser.parse_args()
    if len(args)!=2:
        parser.error("incorrect number of arguments")

    n=len(opts.ligand)
    if n<2:
        parser.error("need at least 2 ligand selections")
    print "Sigma scale:   %s" % opts.scale_sigma
    print "Epsilon scale: %s" % opts.scale_epsilon

    ifile, ofile = args
    print "Loading DMS file <%s>" % ifile
    mol=msys.LoadDMS(ifile)

    for i in range(0,n):
        s1 = mol.select(opts.ligand[i])
        name = '1st' if i==0 else '2nd' if i==1 else '3rd' if i==2 else '%sth' % (i+1)

        if not s1:
            print "ERROR: No atoms in the %s selection: %s" % (
                    name, opts.ligand[i])
            exit(1)
        else:
            print "Selected %d atoms with %s selection" % (len(s1), name)
        for j in range(i+1,n):
            s2 = mol.select(opts.ligand[j])
            vdw.Scale(mol, s1, s2, opts.scale_sigma, opts.scale_epsilon)

    mol.coalesceTables()
    mol = mol.clone()
    print "Writing DMS file <%s>" % ofile
    msys.SaveDMS(mol, ofile)
    print "OK"

if __name__=="__main__": main()

# vim: filetype=python
